<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squad Goals</title>
    <style>
        /* --- 1. GLOBAL RESET & BASICS --- */
        * { box-sizing: border-box; }
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --border: #30363d; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        h1 { margin-bottom: 20px; color: #f0f6fc; }

        /* --- 2. USER SPECIFIC THEMES (Tejas=Red, Akash=Green, Krishna=Blue) --- */
        .theme-user1 { --accent: #ff5252; --accent-dim: rgba(255, 82, 82, 0.2); }
        .theme-user2 { --accent: #2ea043; --accent-dim: rgba(46, 160, 67, 0.2); }
        .theme-user3 { --accent: #2f81f7; --accent-dim: rgba(47, 129, 247, 0.2); }

        /* --- 3. UI ELEMENTS --- */
        select, button, input { padding: 10px 15px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.9rem; outline: none; background: #21262d; color: white; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        .btn-main { background: #238636; color: white; border: none; width: 100%; }
        
        /* Screens */
        .screen { text-align: center; margin-top: 50px; display: none; width: 100%; max-width: 400px; }
        .screen.visible { display: block; }
        
        /* --- 4. DASHBOARD GRID --- */
        #dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 100%; max-width: 1200px; display: none; }
        #dashboard.visible { display: grid; }
        
        /* --- 5. CARD DESIGN --- */
        .card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .card.active { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-dim); }

        .header { display: flex; justify-content: space-between; align-items: center; }
        .name { font-size: 1.2rem; font-weight: bold; color: var(--accent); }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; background: #21262d; border: 1px solid var(--border); }
        .active .status-badge { background: var(--accent); color: white; border-color: var(--accent); }

        .timer-display { font-size: 2.5rem; font-family: monospace; font-weight: bold; text-align: center; margin: 10px 0; }
        
        /* --- 6. HEATMAP (GitHub Style) --- */
        .heatmap-container { display: flex; flex-direction: column; gap: 5px; }
        .heatmap-label { font-size: 0.75rem; color: #8b949e; display: flex; justify-content: space-between; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(15, 1fr); gap: 4px; } /* 2 weeks per row roughly */
        .day-box { aspect-ratio: 1; border-radius: 2px; background: #2d333b; }
        /* Opacity levels for activity */
        .level-1 { background: var(--accent); opacity: 0.3; }
        .level-2 { background: var(--accent); opacity: 0.5; }
        .level-3 { background: var(--accent); opacity: 0.7; }
        .level-4 { background: var(--accent); opacity: 1.0; }

        /* --- 7. CONTROLS --- */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .btn-action { background: var(--accent); color: white; border: none; }
        .btn-stop { background: #da3633; color: white; border: none; }
        
        /* Goal Input */
        .goal-input-area { grid-column: span 2; display: none; gap: 8px; width: 100%; }
        .goal-input-area.show { display: flex; align-items: center; }
        .goal-input-area input { flex: 1; } 
    </style>
</head>
<body>

    <h1>ðŸš€ Squad Tracker</h1>

    <div id="gate-screen" class="screen visible">
        <p>ðŸ”’ Enter Squad Password</p>
        <input type="password" id="squad-password" placeholder="Password...">
        <br><br>
        <button class="btn-main" onclick="checkGate()">Unlock</button>
        <p id="error-msg" style="color: #ff5252; display: none; margin-top:10px;">Access Denied</p>
    </div>

    <div id="auth-screen" class="screen">
        <h3>Who are you?</h3>
        <select id="user-select">
            <option value="user1">Tejas</option>
            <option value="user2">Akash</option>
            <option value="user3">Krishna</option>
        </select>
        <br><br>
        <button class="btn-main" onclick="enterDashboard()">Enter Dashboard</button>
    </div>

    <div id="dashboard"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CONFIGURATION ---
        const SHARED_PASSWORD = "focus"; 

        // PASTE FIREBASE CONFIG HERE
        const firebaseConfig = {
            apiKey: "AIzaSyABF7QC5sAGW2SmphPbEwOcRMSml-6Ztks",
            authDomain: "squad-goals-aab2d.firebaseapp.com",
            databaseURL: "https://squad-goals-aab2d-default-rtdb.firebaseio.com",
            projectId: "squad-goals-aab2d",
            storageBucket: "squad-goals-aab2d.firebasestorage.app",
            messagingSenderId: "447626600468",
            appId: "1:447626600468:web:0da98bd1df01ade25d0701"
        };

        const users = { 
            'user1': 'Tejas', 
            'user2': 'Akash', 
            'user3': 'Krishna' 
        }; 
        // ---------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let currentUser = null;
        let localTimers = {};

        // --- AUTH LOGIC ---
        window.checkGate = () => {
            if (document.getElementById('squad-password').value === SHARED_PASSWORD) {
                document.getElementById('gate-screen').classList.remove('visible');
                document.getElementById('auth-screen').classList.add('visible');
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        };

        window.enterDashboard = () => {
            currentUser = document.getElementById('user-select').value;
            document.getElementById('auth-screen').classList.remove('visible');
            document.getElementById('dashboard').classList.add('visible');
            
            onValue(ref(db, 'users'), (snapshot) => {
                renderCards(snapshot.val() || {});
            });
        };

        // --- RENDER LOGIC ---
        function renderCards(data) {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            const todayStr = getTodayString();

            Object.keys(users).forEach(key => {
                const userData = data[key] || {};
                const history = userData.history || {};
                const isMe = key === currentUser;
                
                // Get time strictly for TODAY from history, or 0
                const todayTotal = history[todayStr] || 0;
                
                // Live calculation
                let currentSession = userData.isStudying ? (Date.now() - userData.startTime) : 0;
                let displayTotal = todayTotal + currentSession;
                let goal = userData.dailyGoal || 3600000;

                const card = document.createElement('div');
                // Assign Theme Class based on user key
                card.className = `card theme-${key} ${userData.isStudying ? 'active' : ''}`;
                
                card.innerHTML = `
                    <div class="header">
                        <span class="name">${users[key]} ${isMe ? '(You)' : ''}</span>
                        <span class="status-badge">
                            ${userData.isStudying ? 'ðŸ”¥ CRUSHING IT' : 'ðŸ’¤ SLACKING'}
                        </span>
                    </div>

                    <div class="timer-display" id="timer-${key}">
                        ${formatTime(displayTotal)}
                    </div>

                    <div class="heatmap-container">
                        <div class="heatmap-label">
                            <span>Last 30 Days</span>
                            <span>Goal: ${formatHours(goal)}</span>
                        </div>
                        <div class="heatmap-grid">
                            ${generateHeatmapHTML(history, goal)}
                        </div>
                    </div>

                    ${isMe ? `
                    <div class="controls">
                        ${!userData.isStudying 
                            ? `<button class="btn-action" onclick="toggleStudy('${key}', true)">Start Focus</button>` 
                            : `<button class="btn-stop" onclick="toggleStudy('${key}', false)">Stop</button>`
                        }
                        <button style="background:#21262d" onclick="toggleGoalInput('${key}')">Set Goal</button>
                        
                        <div id="goal-input-${key}" class="goal-input-area">
                            <input type="number" id="input-hours-${key}" placeholder="Hrs" min="0.5" step="0.5">
                            <button class="btn-main" style="width:auto;" onclick="saveGoal('${key}')">Save</button>
                        </div>
                    </div>
                    ` : ''}
                `;
                container.appendChild(card);

                // Live Ticking
                if (localTimers[key]) clearInterval(localTimers[key]);
                if (userData.isStudying) {
                    localTimers[key] = setInterval(() => {
                        const now = Date.now();
                        const liveDiff = now - userData.startTime;
                        // Update the timer display with History + Current Session
                        document.getElementById(`timer-${key}`).innerText = formatTime(todayTotal + liveDiff);
                    }, 1000);
                }
            });
        }

        // --- HEATMAP GENERATOR ---
        function generateHeatmapHTML(history, goal) {
            let html = '';
            // Generate last 30 days
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD
                
                const ms = history[dateStr] || 0;
                let level = '';
                
                // Color intensity logic
                if (ms > 0) level = 'level-1';
                if (ms > goal * 0.25) level = 'level-2';
                if (ms > goal * 0.5) level = 'level-3';
                if (ms >= goal) level = 'level-4';

                html += `<div class="day-box ${level}" title="${dateStr}: ${formatHours(ms)}"></div>`;
            }
            return html;
        }

        // --- ACTIONS ---
        window.toggleStudy = (uid, start) => {
            const userRef = ref(db, `users/${uid}`);
            const todayStr = getTodayString();

            if (start) {
                update(userRef, { isStudying: true, startTime: Date.now() });
            } else {
                // Fetch current state to save history safely
                get(userRef).then((snapshot) => {
                    const data = snapshot.val();
                    if (data && data.isStudying) {
                        const sessionTime = Date.now() - data.startTime;
                        
                        // Get existing time for TODAY
                        const currentHistory = data.history || {};
                        const previousTodayTotal = currentHistory[todayStr] || 0;
                        const newTotal = previousTodayTotal + sessionTime;

                        // Save to specific date node
                        update(userRef, { 
                            isStudying: false, 
                            startTime: null,
                            [`history/${todayStr}`]: newTotal // Updates specific date key
                        });
                    }
                });
            }
        };

        window.toggleGoalInput = (uid) => {
            document.getElementById(`goal-input-${uid}`).classList.toggle('show');
        };

        window.saveGoal = (uid) => {
            const hours = parseFloat(document.getElementById(`input-hours-${uid}`).value);
            if (hours) {
                update(ref(db, `users/${uid}`), { dailyGoal: hours * 3600000 });
                toggleGoalInput(uid);
            }
        };

        // --- HELPERS ---
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        function formatTime(ms) {
            const s = Math.floor((ms/1000)%60);
            const m = Math.floor((ms/(1000*60))%60);
            const h = Math.floor((ms/(1000*60*60)));
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }
        function formatHours(ms) {
            return (ms / (1000*60*60)).toFixed(1) + 'h';
        }
        function pad(n) { return n < 10 ? '0'+n : n; }
    </script>
</body>
</html>
