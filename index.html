<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squad Goals</title>
    <style>
        /* --- 1. GLOBAL RESET & BASICS --- */
        * { box-sizing: border-box; }
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --border: #30363d; --modal-bg: #0d1117; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        h1 { margin-bottom: 20px; color: #f0f6fc; }

        /* --- 2. USER THEMES --- */
        .theme-user1 { --accent: #ff5252; --tint: rgba(255, 82, 82, 0.1); } 
        .theme-user2 { --accent: #2ea043; --tint: rgba(46, 160, 67, 0.1); } 
        .theme-user3 { --accent: #2f81f7; --tint: rgba(47, 129, 247, 0.1); } 

        /* --- 3. UI ELEMENTS --- */
        select, button, input { padding: 10px 15px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.9rem; outline: none; background: #21262d; color: white; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        .btn-main { background: #238636; color: white; border: none; width: 100%; }
        
        /* Screens */
        .screen { text-align: center; margin-top: 50px; display: none; width: 100%; max-width: 400px; }
        .screen.visible { display: block; }
        
        /* --- 4. DASHBOARD --- */
        #dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; width: 100%; max-width: 1200px; display: none; }
        #dashboard.visible { display: grid; }
        
        /* --- 5. CARDS --- */
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .card.active { border-color: var(--accent); box-shadow: 0 0 15px rgba(0,0,0,0.2); }

        .header { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .identity { display: flex; flex-direction: column; }
        .name { font-size: 1.4rem; font-weight: bold; color: var(--accent); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-underline-offset: 4px; }
        .streak { font-size: 0.85rem; color: #ffa000; margin-top: 4px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; background: #21262d; border: 1px solid var(--border); white-space: nowrap; }
        .active .status-badge { background: var(--accent); color: white; border-color: var(--accent); }

        .current-task { font-size: 0.95rem; color: #8b949e; text-align: center; font-style: italic; min-height: 1.4em; }
        .active .current-task { color: #e6edf3; text-shadow: 0 0 10px rgba(255,255,255,0.1); }

        /* --- DUAL TIMER LAYOUT --- */
        .timer-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 5px 0; }
        .timer-box { background: #0d1117; border-radius: 8px; padding: 10px; text-align: center; border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: center; }
        .active .timer-box.session { background: var(--tint); border-color: var(--accent); }
        .timer-val { font-family: monospace; font-size: 1.6rem; font-weight: bold; letter-spacing: -1px; color: white; }
        .timer-lbl { font-size: 0.7rem; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }

        /* --- 6. HEATMAP --- */
        .heatmap-container { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        .heatmap-label { font-size: 0.75rem; color: #8b949e; display: flex; justify-content: space-between; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(15, 1fr); gap: 4px; } 
        .day-box { aspect-ratio: 1; border-radius: 2px; background: #2d333b; }
        .day-box.empty { background: transparent; border: none; }

        .hm-red     { background-color: #ff5252; }
        .hm-yellow  { background-color: #ffd700; }
        .hm-lgreen  { background-color: #69f0ae; }
        .hm-dgreen  { background-color: #00c853; }

        /* --- 7. MODAL --- */
        #history-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #history-modal.open { display: flex; }
        .modal-content { background: #161b22; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 12px; border: 1px solid #30363d; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; background: #0d1117; }
        .modal-title { font-weight: bold; font-size: 1.2rem; color: white; }
        .close-btn { background: none; border: none; color: #8b949e; font-size: 1.5rem; padding: 0; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #30363d; }
        .stat-item { flex: 1; background: #21262d; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: white; display: block; }
        .stat-lbl { font-size: 0.8rem; color: #8b949e; }
        .year-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .month-block { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 10px; }
        .month-title { font-size: 0.9rem; color: #8b949e; margin-bottom: 8px; text-align: center; font-weight: bold; }
        .week-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 2px; }
        .week-day { font-size: 0.6rem; color: #6e7681; text-align: center; }
        .month-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .month-days .day-box { width: 100%; border-radius: 1px; aspect-ratio: 1; }

        /* --- 8. CONTROLS --- */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .btn-action { background: var(--accent); color: white; border: none; }
        .btn-stop { background: #da3633; color: white; border: none; }
        
        .goal-input-area { grid-column: span 2; display: none; gap: 8px; width: 100%; }
        .goal-input-area.show { display: flex; align-items: center; }
        .goal-input-area input { flex: 1; min-width: 0; } 
        .goal-input-area button { flex-shrink: 0; width: auto; white-space: nowrap; } 
    </style>
</head>
<body>

    <h1>ðŸš€ Squad Goals</h1>

    <div id="history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modal-user-name">Year Review</span>
                <button class="close-btn" onclick="closeHistory()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-val" id="stat-total-hrs">0h</span>
                        <span class="stat-lbl" id="stat-year-lbl">2026 Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="stat-streak">0</span>
                        <span class="stat-lbl">Current Streak ðŸ”¥</span>
                    </div>
                </div>
                <div id="year-grid-container" class="year-grid"></div>
            </div>
        </div>
    </div>

    <div id="gate-screen" class="screen visible">
        <p>ðŸ”’ Enter Squad Password</p>
        <input type="password" id="squad-password" placeholder="Password...">
        <br><br>
        <button class="btn-main" onclick="checkGate()">Unlock</button>
        <p id="error-msg" style="color: #ff5252; display: none; margin-top:10px;">Incorrect Password</p>
    </div>

    <div id="auth-screen" class="screen">
        <h3>Who are you?</h3>
        <select id="user-select">
            <option value="user1">Tejas</option>
            <option value="user2">Akash</option>
            <option value="user3">Krishna</option>
        </select>
        <br><br>
        <button class="btn-main" onclick="enterDashboard()">Enter Dashboard</button>
    </div>

    <div id="dashboard"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CONFIGURATION ---
        const SHARED_PASSWORD = "focus"; 
        const firebaseConfig = {
            apiKey: "AIzaSyABF7QC5sAGW2SmphPbEwOcRMSml-6Ztks",
            authDomain: "squad-goals-aab2d.firebaseapp.com",
            databaseURL: "https://squad-goals-aab2d-default-rtdb.firebaseio.com",
            projectId: "squad-goals-aab2d",
            storageBucket: "squad-goals-aab2d.firebasestorage.app",
            messagingSenderId: "447626600468",
            appId: "1:447626600468:web:0da98bd1df01ade25d0701"
        };
        const users = { 'user1': 'Tejas', 'user2': 'Akash', 'user3': 'Krishna' }; 
        // ---------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let currentUser = null;
        let localTimers = {};
        let globalData = {}; 

        // --- AUTH ---
        window.checkGate = () => {
            const input = document.getElementById('squad-password').value.trim().toLowerCase();
            const correct = SHARED_PASSWORD.toLowerCase();
            
            if (input === correct) {
                document.getElementById('gate-screen').classList.remove('visible');
                document.getElementById('auth-screen').classList.add('visible');
            } else {
                document.getElementById('error-msg').innerText = "Incorrect Password. Try 'focus'";
                document.getElementById('error-msg').style.display = 'block';
            }
        };

        window.enterDashboard = () => {
            currentUser = document.getElementById('user-select').value;
            document.getElementById('auth-screen').classList.remove('visible');
            document.getElementById('dashboard').classList.add('visible');
            
            onValue(ref(db, 'users'), (snapshot) => {
                globalData = snapshot.val() || {};
                renderCards(globalData);
            });
        };

        // --- RENDER DASHBOARD ---
        function renderCards(data) {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            
            const todayStr = getTodayString(); 
            const midnightTimestamp = new Date();
            midnightTimestamp.setHours(0,0,0,0); 

            Object.keys(users).forEach(key => {
                const userData = data[key] || {};
                const history = userData.history || {};
                const isMe = key === currentUser;
                
                // CALC 1: TOTAL TODAY (Resets at Midnight)
                const savedToday = history[todayStr] || 0;
                let activeSessionToday = 0;
                
                // CALC 2: CURRENT SESSION (Continuous)
                let currentSessionTotal = 0;

                if (userData.isStudying && userData.startTime) {
                    currentSessionTotal = Date.now() - userData.startTime;
                    if (userData.startTime < midnightTimestamp.getTime()) {
                        activeSessionToday = Math.max(0, Date.now() - midnightTimestamp.getTime());
                    } else {
                        activeSessionToday = currentSessionTotal;
                    }
                }

                let displayTotal = savedToday + activeSessionToday;
                let goal = userData.dailyGoal || 3600000;
                const streak = calculateStreak(history, goal);
                let statusText = userData.isStudying ? (userData.statusMsg || 'Working...') : 'Resting';

                const card = document.createElement('div');
                card.className = `card theme-${key} ${userData.isStudying ? 'active' : ''}`;
                
                card.innerHTML = `
                    <div class="header">
                        <div class="identity">
                            <span class="name" onclick="openHistory('${key}')">${users[key]} ${isMe ? '(You)' : ''}</span>
                            ${streak > 0 ? `<span class="streak">ðŸ”¥ ${streak} day streak</span>` : ''}
                        </div>
                        <span class="status-badge">
                            ${userData.isStudying ? 'FOCUSING' : 'OFFLINE'}
                        </span>
                    </div>

                    <div class="current-task">${userData.isStudying ? statusText : ''}</div>

                    <div class="timer-row">
                        <div class="timer-box">
                            <span class="timer-lbl">Total Today</span>
                            <span class="timer-val" id="timer-total-${key}">${formatTime(displayTotal)}</span>
                        </div>
                        <div class="timer-box session">
                            <span class="timer-lbl">Current Session</span>
                            <span class="timer-val" id="timer-session-${key}">${formatTime(currentSessionTotal)}</span>
                        </div>
                    </div>

                    <div class="heatmap-container">
                        <div class="heatmap-label">
                            <span>Last 30 Days</span>
                            <span>Goal: ${formatHours(goal)}</span>
                        </div>
                        <div class="heatmap-grid">
                            ${generateDashboardHeatmap(history, goal)}
                        </div>
                    </div>

                    ${isMe ? `
                    <div class="controls">
                        ${!userData.isStudying 
                            ? `<button class="btn-action" onclick="promptStart('${key}')">Start Focus</button>` 
                            : `<button class="btn-stop" onclick="toggleStudy('${key}', false)">Stop</button>`
                        }
                        <button style="background:#21262d" onclick="toggleGoalInput('${key}')">Set Goal</button>
                        <div id="goal-input-${key}" class="goal-input-area">
                            <input type="number" id="input-hours-${key}" placeholder="Hrs" min="0.5" step="0.5">
                            <button class="btn-main" onclick="saveGoal('${key}')">Save</button>
                        </div>
                    </div>
                    ` : ''}
                `;
                container.appendChild(card);

                // LIVE UPDATER
                if (localTimers[key]) clearInterval(localTimers[key]);
                if (userData.isStudying) {
                    localTimers[key] = setInterval(() => {
                        const now = Date.now();
                        const currentMidnight = new Date();
                        currentMidnight.setHours(0,0,0,0);
                        
                        const sessionDiff = now - userData.startTime;
                        document.getElementById(`timer-session-${key}`).innerText = formatTime(sessionDiff);

                        let todayDiff = 0;
                        if (userData.startTime < currentMidnight.getTime()) {
                            todayDiff = now - currentMidnight.getTime();
                        } else {
                            todayDiff = sessionDiff;
                        }
                        document.getElementById(`timer-total-${key}`).innerText = formatTime(savedToday + todayDiff);

                    }, 1000);
                }
            });
        }

        // --- ACTION LOGIC ---
        window.promptStart = (uid) => {
            const task = prompt("What are you working on?", "Studying");
            if (task !== null) toggleStudy(uid, true, task);
        };

        window.toggleStudy = (uid, start, taskMsg = "") => {
            const userRef = ref(db, `users/${uid}`);
            
            if (start) {
                update(userRef, { isStudying: true, startTime: Date.now(), statusMsg: taskMsg });
            } else {
                get(userRef).then((snapshot) => {
                    const data = snapshot.val();
                    if (data && data.isStudying) {
                        const now = Date.now();
                        const start = data.startTime;
                        
                        const startObj = new Date(start);
                        const endObj = new Date(now);
                        const startDayStr = startObj.toISOString().split('T')[0];
                        const endDayStr = endObj.toISOString().split('T')[0];

                        const currentHistory = data.history || {};
                        let updates = { isStudying: false, startTime: null, statusMsg: null };

                        if (startDayStr === endDayStr) {
                            const duration = now - start;
                            const oldTotal = currentHistory[endDayStr] || 0;
                            updates[`history/${endDayStr}`] = oldTotal + duration;
                        } else {
                            const midnight = new Date(endObj);
                            midnight.setHours(0,0,0,0);
                            
                            const yesterdayMs = midnight.getTime() - start;
                            const todayMs = now - midnight.getTime();
                            
                            const prevDayTotal = currentHistory[startDayStr] || 0;
                            updates[`history/${startDayStr}`] = prevDayTotal + yesterdayMs;
                            
                            const todayTotal = currentHistory[endDayStr] || 0;
                            updates[`history/${endDayStr}`] = todayTotal + todayMs;
                        }
                        update(userRef, updates);
                    }
                });
            }
        };

        // --- STREAK LOGIC ---
        function calculateStreak(history, goal) {
            let streak = 0;
            const d = new Date();
            d.setDate(d.getDate() - 1); // Check yesterday first
            
            for(let i=0; i<365; i++) {
                const dateStr = d.toISOString().split('T')[0];
                const ms = history[dateStr] || 0;
                if(ms >= goal) {
                    streak++;
                } else {
                    break; 
                }
                d.setDate(d.getDate() - 1);
            }
            return streak;
        }

        // --- HISTORY MODAL ---
        window.openHistory = (uid) => {
            const userData = globalData[uid] || {};
            const history = userData.history || {};
            const goal = userData.dailyGoal || 3600000;
            const streak = calculateStreak(history, goal);
            const modal = document.getElementById('history-modal');
            const currentYear = new Date().getFullYear();
            
            document.getElementById('modal-user-name').innerText = `${users[uid]}'s ${currentYear}`;
            document.getElementById('stat-year-lbl').innerText = `${currentYear} Total`;
            document.getElementById('stat-streak').innerText = streak;
            
            const container = document.getElementById('year-grid-container');
            container.innerHTML = '';
            
            let totalYearMs = 0;
            for (let month = 0; month < 12; month++) {
                const d = new Date(currentYear, month, 1);
                const monthName = d.toLocaleString('default', { month: 'long', year: 'numeric' });
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                const startDay = d.getDay(); 
                
                let monthHTML = `
                    <div class="month-block">
                        <div class="month-title">${monthName}</div>
                        <div class="week-header">
                            <div class="week-day">S</div><div class="week-day">M</div><div class="week-day">T</div><div class="week-day">W</div><div class="week-day">T</div><div class="week-day">F</div><div class="week-day">S</div>
                        </div>
                        <div class="month-days">
                `;
                for(let s=0; s<startDay; s++) monthHTML += `<div class="day-box empty"></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${pad(month + 1)}-${pad(day)}`;
                    const ms = history[dateStr] || 0;
                    totalYearMs += ms;
                    let classes = getColorClass(ms, goal);
                    if (new Date(dateStr) > new Date()) classes = ''; 
                    monthHTML += `<div class="day-box ${classes}" title="${dateStr}: ${formatHours(ms)}"></div>`;
                }
                monthHTML += `</div></div>`;
                container.insertAdjacentHTML('beforeend', monthHTML);
            }
            document.getElementById('stat-total-hrs').innerText = formatHours(totalYearMs);
            modal.classList.add('open');
        };
        window.closeHistory = () => document.getElementById('history-modal').classList.remove('open');

        // --- HELPERS ---
        function getColorClass(ms, goal) {
            if (ms < 3600000) return ''; 
            const pct = (ms / goal) * 100;
            if (pct >= 100) return 'hm-dgreen';
            if (pct >= 80) return 'hm-lgreen';
            if (pct >= 40) return 'hm-yellow';
            return 'hm-red';
        }

        function generateDashboardHeatmap(history, goal) {
            let html = '';
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const ms = history[dateStr] || 0;
                html += `<div class="day-box ${getColorClass(ms, goal)}" title="${dateStr}"></div>`;
            }
            return html;
        }

        window.toggleGoalInput = (uid) => document.getElementById(`goal-input-${uid}`).classList.toggle('show');
        window.saveGoal = (uid) => {
            const hours = parseFloat(document.getElementById(`input-hours-${uid}`).value);
            if (hours) { update(ref(db, `users/${uid}`), { dailyGoal: hours * 3600000 }); toggleGoalInput(uid); }
        };

        function getTodayString() { 
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(d - offset)).toISOString().slice(0, -1);
            return localISOTime.split('T')[0];
        }

        function formatTime(ms) { 
            const s = Math.floor((ms/1000)%60); 
            const m = Math.floor((ms/(1000*60))%60); 
            const h = Math.floor((ms/(1000*60*60))); 
            return `${pad(h)}:${pad(m)}:${pad(s)}`; 
        }
        function formatHours(ms) { return (ms / (1000*60*60)).toFixed(1) + 'h'; }
        function pad(n) { return n < 10 ? '0'+n : n; }
    </script>
</body>
</html>
