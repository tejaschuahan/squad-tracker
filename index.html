<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squad Goals</title>
    <style>
        /* --- 1. GLOBAL RESET & BASICS --- */
        * { box-sizing: border-box; }
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --border: #30363d; --modal-bg: #0d1117; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; justify-content: center; }
        
        /* --- 2. USER THEMES --- */
        .theme-user1 { --accent: #ff5252; --tint: rgba(255, 82, 82, 0.1); } 
        .theme-user2 { --accent: #2ea043; --tint: rgba(46, 160, 67, 0.1); } 
        .theme-user3 { --accent: #2f81f7; --tint: rgba(47, 129, 247, 0.1); } 

        /* --- 3. UI ELEMENTS --- */
        select, button, input { padding: 10px 15px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.9rem; outline: none; background: #21262d; color: white; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        .btn-main { background: #238636; color: white; border: none; width: 100%; }
        
        /* Screens */
        .screen { text-align: center; margin-top: 50px; display: none; width: 100%; max-width: 400px; }
        .screen.visible { display: block; }
        
        /* Login Specifics */
        .login-box { background: var(--card); padding: 30px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .login-status { font-size: 0.8rem; color: #8b949e; margin-top: 5px; height: 1.2em; }

        /* --- 4. DASHBOARD --- */
        #dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; width: 100%; max-width: 1200px; display: none; }
        #dashboard.visible { display: grid; }
        
        /* --- 5. CARDS --- */
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .card.active { border-color: var(--accent); box-shadow: 0 0 15px rgba(0,0,0,0.2); }

        .header { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .identity { display: flex; flex-direction: column; }
        .name { font-size: 1.4rem; font-weight: bold; color: var(--accent); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-underline-offset: 4px; }
        .streak { font-size: 0.85rem; color: #ffa000; margin-top: 4px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; background: #21262d; border: 1px solid var(--border); white-space: nowrap; }
        .active .status-badge { background: var(--accent); color: white; border-color: var(--accent); }

        /* Task Display */
        .current-task { font-size: 0.95rem; color: #8b949e; text-align: center; font-style: italic; min-height: 1.4em; border-bottom: 1px dashed #30363d; padding-bottom: 5px; }
        .active .current-task { color: #e6edf3; text-shadow: 0 0 10px rgba(255,255,255,0.1); border-color: var(--accent); }

        /* --- DUAL TIMER --- */
        .timer-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 5px 0; }
        .timer-box { background: #0d1117; border-radius: 8px; padding: 10px; text-align: center; border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: center; }
        .active .timer-box.session { background: var(--tint); border-color: var(--accent); }
        .timer-val { font-family: monospace; font-size: 1.6rem; font-weight: bold; letter-spacing: -1px; color: white; }
        .timer-lbl { font-size: 0.7rem; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }

        /* --- HEATMAP --- */
        .heatmap-container { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        .heatmap-label { font-size: 0.75rem; color: #8b949e; display: flex; justify-content: space-between; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(15, 1fr); gap: 4px; } 
        .day-box { aspect-ratio: 1; border-radius: 2px; background: #2d333b; }
        .day-box.empty { background: transparent; border: none; }
        .hm-red { background-color: #ff5252; } .hm-yellow { background-color: #ffd700; }
        .hm-lgreen { background-color: #69f0ae; } .hm-dgreen { background-color: #00c853; }

        /* --- MODAL --- */
        #history-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #history-modal.open { display: flex; }
        .modal-content { background: #161b22; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 12px; border: 1px solid #30363d; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; background: #0d1117; }
        .modal-title { font-weight: bold; font-size: 1.2rem; color: white; }
        .close-btn { background: none; border: none; color: #8b949e; font-size: 1.5rem; padding: 0; }
        .modal-body { padding: 20px; overflow-y: auto; }

        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #30363d; }
        .stat-item { flex: 1; background: #21262d; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: white; display: block; }
        .stat-lbl { font-size: 0.8rem; color: #8b949e; }

        /* Year Grid */
        .year-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .month-block { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 10px; }
        .month-title { font-size: 0.9rem; color: #8b949e; margin-bottom: 8px; text-align: center; font-weight: bold; }
        .week-header, .month-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .month-days .day-box { width: 100%; border-radius: 1px; aspect-ratio: 1; }

        /* Session Log */
        .log-section-title { font-size: 1rem; color: #c9d1d9; margin-bottom: 10px; border-bottom: 1px solid #30363d; padding-bottom: 5px; }
        .session-list { display: flex; flex-direction: column; gap: 8px; }
        .session-item { background: #0d1117; border-left: 3px solid #30363d; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .session-info { display: flex; flex-direction: column; }
        .session-task { font-weight: bold; color: #e6edf3; font-size: 0.95rem; }
        .session-date { font-size: 0.75rem; color: #8b949e; }
        .session-dur { font-family: monospace; font-size: 0.9rem; color: #79c0ff; background: rgba(56,139,253,0.15); padding: 2px 6px; border-radius: 4px; }

        /* --- 8. CONTROLS --- */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .btn-action { background: var(--accent); color: white; border: none; }
        .btn-stop { background: #da3633; color: white; border: none; }
        .btn-locked { background: #161b22; color: #555; border: 1px solid #30363d; cursor: not-allowed; }
        
        .goal-input-area { grid-column: span 2; display: none; gap: 8px; width: 100%; }
        .goal-input-area.show { display: flex; align-items: center; }
        .goal-input-area input { flex: 1; min-width: 0; } 
        .goal-input-area button { flex-shrink: 0; width: auto; white-space: nowrap; } 
    </style>
</head>
<body>

    <div id="history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modal-user-name">Profile</span>
                <button class="close-btn" onclick="closeHistory()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-val" id="stat-total-hrs">0h</span>
                        <span class="stat-lbl" id="stat-year-lbl">2026 Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="stat-streak">0</span>
                        <span class="stat-lbl">Current Streak ðŸ”¥</span>
                    </div>
                </div>
                <div id="year-grid-container" class="year-grid"></div>
                <div class="log-section-title">Session Log (Completed Tasks)</div>
                <div id="session-log-container" class="session-list"></div>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="screen visible">
        <div class="login-box">
            <h3>Squad Login</h3>
            <select id="user-select" onchange="checkUserStatus()">
                <option value="" disabled selected>Select User...</option>
                <option value="user1">Tejas</option>
                <option value="user2">Akash</option>
                <option value="user3">Krishna</option>
            </select>
            <input type="password" id="user-password" placeholder="Enter Password">
            <button class="btn-main" id="login-btn" onclick="handleLogin()">Login</button>
            <div id="login-msg" class="login-status"></div>
        </div>
    </div>

    <div id="dashboard"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onValue, get, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyABF7QC5sAGW2SmphPbEwOcRMSml-6Ztks",
            authDomain: "squad-goals-aab2d.firebaseapp.com",
            databaseURL: "https://squad-goals-aab2d-default-rtdb.firebaseio.com",
            projectId: "squad-goals-aab2d",
            storageBucket: "squad-goals-aab2d.firebasestorage.app",
            messagingSenderId: "447626600468",
            appId: "1:447626600468:web:0da98bd1df01ade25d0701"
        };
        const users = { 'user1': 'Tejas', 'user2': 'Akash', 'user3': 'Krishna' }; 
        // ---------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let localTimers = {};
        let globalData = {}; 

        // --- ANONYMOUS AUTH ---
        signInAnonymously(auth).catch((error) => {
            console.error("Auth Error:", error);
            document.getElementById('login-msg').innerText = "Auth Error: Enable Anonymous Auth in Firebase Console!";
            document.getElementById('login-msg').style.color = "red";
        });

        // --- AUTH & SECURITY LOGIC ---
        async function hashPassword(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        window.checkUserStatus = () => {
            const uid = document.getElementById('user-select').value;
            const btn = document.getElementById('login-btn');
            const msg = document.getElementById('login-msg');
            
            get(ref(db, `users/${uid}/passwordHash`)).then((snapshot) => {
                if (snapshot.exists()) {
                    btn.innerText = "Login";
                    msg.innerText = "";
                } else {
                    btn.innerText = "Register / Set Password";
                    msg.innerText = "First time? Create a password.";
                    msg.style.color = "#4caf50";
                }
            });
        };

        window.handleLogin = async () => {
            const uid = document.getElementById('user-select').value;
            const pass = document.getElementById('user-password').value;
            const msg = document.getElementById('login-msg');

            if (!uid || !pass) {
                msg.innerText = "Please select user and enter password.";
                msg.style.color = "#ff5252";
                return;
            }

            const inputHash = await hashPassword(pass);
            const userRef = ref(db, `users/${uid}`);

            get(userRef).then((snapshot) => {
                const data = snapshot.val() || {};
                if (data.passwordHash) {
                    if (data.passwordHash === inputHash) {
                        enterDashboard(uid);
                    } else {
                        msg.innerText = "Wrong Password!";
                        msg.style.color = "#ff5252";
                    }
                } else {
                    if(confirm(`Set password for ${users[uid]}? You cannot change this easily.`)) {
                        update(userRef, { passwordHash: inputHash }).catch(err => {
                            alert("Database Error: " + err.message);
                        });
                        enterDashboard(uid);
                    }
                }
            });
        };

        function enterDashboard(uid) {
            currentUser = uid;
            document.getElementById('auth-screen').classList.remove('visible');
            document.getElementById('dashboard').classList.add('visible');
            onValue(ref(db, 'users'), (snapshot) => {
                globalData = snapshot.val() || {};
                renderCards(globalData);
            });
        }

        // --- RENDER DASHBOARD ---
        function renderCards(data) {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            const todayStr = getLocalDayStr(); 
            const midnightTimestamp = new Date();
            midnightTimestamp.setHours(0,0,0,0); 

            Object.keys(users).forEach(key => {
                const userData = data[key] || {};
                const history = userData.history || {};
                const historyGoals = userData.goals || {}; 
                const goalLocks = userData.goalLocks || {}; 
                const isMe = key === currentUser;
                
                const savedToday = history[todayStr] || 0;
                let activeSessionToday = 0;
                let currentSessionTotal = 0;

                // --- ROBUST NAN PROTECTION ---
                if (userData.isStudying && userData.startTime && !isNaN(userData.startTime)) {
                    currentSessionTotal = Date.now() - userData.startTime;
                    if (userData.startTime < midnightTimestamp.getTime()) {
                        activeSessionToday = Math.max(0, Date.now() - midnightTimestamp.getTime());
                    } else {
                        activeSessionToday = currentSessionTotal;
                    }
                }
                let displayTotal = savedToday + activeSessionToday;
                const todayGoal = historyGoals[todayStr] || userData.dailyGoal || 3600000;
                const streak = calculateStreak(history, historyGoals, userData.dailyGoal);
                
                let currentTaskName = userData.currentTask || "No active task";
                const isGoalLocked = goalLocks[todayStr] === true;

                const card = document.createElement('div');
                card.className = `card theme-${key} ${userData.isStudying ? 'active' : ''}`;
                
                card.innerHTML = `
                    <div class="header">
                        <div class="identity">
                            <span class="name" onclick="openHistory('${key}')">${users[key]} ${isMe ? '(You)' : ''}</span>
                            ${streak > 0 ? `<span class="streak">ðŸ”¥ ${streak} day streak</span>` : ''}
                        </div>
                        <span class="status-badge">
                            ${userData.isStudying ? 'FOCUSING' : 'OFFLINE'}
                        </span>
                    </div>

                    <div class="current-task">${currentTaskName}</div>

                    <div class="timer-row">
                        <div class="timer-box">
                            <span class="timer-lbl">Total Today</span>
                            <span class="timer-val" id="timer-total-${key}">${formatTime(displayTotal)}</span>
                        </div>
                        <div class="timer-box session">
                            <span class="timer-lbl">Current Session</span>
                            <span class="timer-val" id="timer-session-${key}">${formatTime(currentSessionTotal)}</span>
                        </div>
                    </div>

                    <div class="heatmap-container">
                        <div class="heatmap-label">
                            <span>Last 30 Days</span>
                            <span>Goal: ${formatHours(todayGoal)}</span>
                        </div>
                        <div class="heatmap-grid">
                            ${generateDashboardHeatmap(history, historyGoals, userData.dailyGoal)}
                        </div>
                    </div>

                    ${isMe ? `
                    <div class="controls">
                        ${!userData.isStudying 
                            ? `<button class="btn-action" onclick="promptStart('${key}', '${userData.currentTask || ''}')">Start Focus</button>` 
                            : `<button class="btn-stop" onclick="toggleStudy('${key}', false)">Stop</button>`
                        }
                        
                        ${!isGoalLocked 
                            ? `<button style="background:#21262d" onclick="toggleGoalInput('${key}')">Set Goal</button>`
                            : `<button class="btn-locked" disabled>ðŸ”’ Goal Locked</button>`
                        }

                        <div id="goal-input-${key}" class="goal-input-area">
                            <input type="number" id="input-hours-${key}" placeholder="Hrs" min="0.5" step="0.5">
                            <button class="btn-main" onclick="saveGoal('${key}')">Save</button>
                        </div>
                    </div>
                    ` : ''}
                `;
                container.appendChild(card);

                if (localTimers[key]) clearInterval(localTimers[key]);
                if (userData.isStudying) {
                    localTimers[key] = setInterval(() => {
                        const now = Date.now();
                        const currentMidnight = new Date();
                        currentMidnight.setHours(0,0,0,0);
                        // Safe Calculation inside interval
                        const validStart = (userData.startTime && !isNaN(userData.startTime)) ? userData.startTime : now;
                        
                        const sessionDiff = now - validStart;
                        document.getElementById(`timer-session-${key}`).innerText = formatTime(sessionDiff);
                        let todayDiff = 0;
                        if (validStart < currentMidnight.getTime()) {
                            todayDiff = now - currentMidnight.getTime();
                        } else {
                            todayDiff = sessionDiff;
                        }
                        document.getElementById(`timer-total-${key}`).innerText = formatTime(savedToday + todayDiff);
                    }, 1000);
                }
            });
        }

        // --- ACTION LOGIC ---
        window.promptStart = (uid, lastTask) => {
            const task = prompt("What are you working on?", lastTask || "Studying");
            if (task !== null) toggleStudy(uid, true, task);
        };

        window.toggleStudy = (uid, start, taskMsg = "") => {
            const userRef = ref(db, `users/${uid}`);
            
            if (start) {
                update(userRef, { 
                    isStudying: true, 
                    startTime: Date.now(), 
                    currentTask: taskMsg 
                }).catch(err => alert("Start Error: " + err.message));
            } else {
                get(userRef).then((snapshot) => {
                    const data = snapshot.val();
                    if (data && data.isStudying) {
                        const now = Date.now();
                        const start = data.startTime;
                        // NaN Protection
                        if(!start || isNaN(start)) {
                            // If corrupt data, force reset without saving bad math
                            update(userRef, { isStudying: false, startTime: null });
                            return;
                        }

                        const duration = now - start;
                        
                        const taskName = data.currentTask || "Unknown";
                        push(ref(db, `users/${uid}/sessions`), {
                            task: taskName,
                            startTime: start,
                            endTime: now,
                            duration: duration
                        });

                        const startDayStr = getLocalDayStr(start);
                        const endDayStr = getLocalDayStr(now);
                        const currentHistory = data.history || {};
                        const currentGoals = data.goals || {};
                        const defaultGoal = data.dailyGoal || 3600000;
                        
                        let updates = { isStudying: false, startTime: null };

                        // SNAPSHOT ONLY (Do NOT lock)
                        if (!currentGoals[endDayStr]) updates[`goals/${endDayStr}`] = defaultGoal;
                        if (startDayStr !== endDayStr && !currentGoals[startDayStr]) updates[`goals/${startDayStr}`] = defaultGoal;

                        if (startDayStr === endDayStr) {
                            updates[`history/${endDayStr}`] = (currentHistory[endDayStr] || 0) + duration;
                        } else {
                            const midnight = new Date(now);
                            midnight.setHours(0,0,0,0);
                            const yesterdayMs = midnight.getTime() - start;
                            const todayMs = now - midnight.getTime();
                            updates[`history/${startDayStr}`] = (currentHistory[startDayStr] || 0) + yesterdayMs;
                            updates[`history/${endDayStr}`] = (currentHistory[endDayStr] || 0) + todayMs;
                        }
                        update(userRef, updates).catch(err => alert("Save Error: " + err.message));
                    }
                });
            }
        };

        // --- HISTORY MODAL ---
        window.openHistory = (uid) => {
            const userData = globalData[uid] || {};
            const history = userData.history || {};
            const historyGoals = userData.goals || {};
            const sessions = userData.sessions || {};
            const defaultGoal = userData.dailyGoal || 3600000;
            const streak = calculateStreak(history, historyGoals, defaultGoal);
            const modal = document.getElementById('history-modal');
            const currentYear = new Date().getFullYear();
            
            document.getElementById('modal-user-name').innerText = `${users[uid]}'s Profile`;
            document.getElementById('stat-year-lbl').innerText = `${currentYear} Total`;
            document.getElementById('stat-streak').innerText = streak;
            
            const container = document.getElementById('year-grid-container');
            container.innerHTML = '';
            let totalYearMs = 0;
            for (let month = 0; month < 12; month++) {
                const d = new Date(currentYear, month, 1);
                const monthName = d.toLocaleString('default', { month: 'long', year: 'numeric' });
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                const startDay = d.getDay(); 
                let monthHTML = `<div class="month-block"><div class="month-title">${monthName}</div><div class="week-header"><div class="week-day">S</div><div class="week-day">M</div><div class="week-day">T</div><div class="week-day">W</div><div class="week-day">T</div><div class="week-day">F</div><div class="week-day">S</div></div><div class="month-days">`;
                for(let s=0; s<startDay; s++) monthHTML += `<div class="day-box empty"></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const cellDate = new Date(currentYear, month, day);
                    const dateStr = getLocalDayStr(cellDate.getTime());
                    const ms = history[dateStr] || 0;
                    totalYearMs += ms;
                    const target = historyGoals[dateStr] || defaultGoal;
                    let classes = getColorClass(ms, target);
                    if (cellDate > new Date()) classes = ''; 
                    monthHTML += `<div class="day-box ${classes}" title="${dateStr}: ${formatHours(ms)}"></div>`;
                }
                monthHTML += `</div></div>`;
                container.insertAdjacentHTML('beforeend', monthHTML);
            }
            document.getElementById('stat-total-hrs').innerText = formatHours(totalYearMs);

            const logContainer = document.getElementById('session-log-container');
            logContainer.innerHTML = '';
            const sessionArray = Object.values(sessions).sort((a, b) => b.endTime - a.endTime);
            if (sessionArray.length === 0) {
                logContainer.innerHTML = '<div style="color:#555; text-align:center;">No completed sessions yet.</div>';
            } else {
                sessionArray.slice(0, 50).forEach(session => {
                    const dateObj = new Date(session.endTime);
                    const dateDisplay = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const itemHTML = `<div class="session-item"><div class="session-info"><span class="session-task">${session.task}</span><span class="session-date">${dateDisplay}</span></div><span class="session-dur">${formatTime(session.duration)}</span></div>`;
                    logContainer.insertAdjacentHTML('beforeend', itemHTML);
                });
            }
            modal.classList.add('open');
        };
        window.closeHistory = () => document.getElementById('history-modal').classList.remove('open');

        // --- UTILS & CALCULATIONS ---
        function calculateStreak(history, historyGoals, defaultGoal) {
            let streak = 0;
            const d = new Date();
            d.setDate(d.getDate() - 1); 
            for(let i=0; i<365; i++) {
                const dateStr = getLocalDayStr(d.getTime());
                const ms = history[dateStr] || 0;
                const target = historyGoals[dateStr] || defaultGoal || 3600000;
                if(ms >= target) streak++; else break; 
                d.setDate(d.getDate() - 1);
            }
            return streak;
        }
        function generateDashboardHeatmap(history, historyGoals, defaultGoal) {
            let html = '';
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = getLocalDayStr(d.getTime());
                const ms = history[dateStr] || 0;
                const target = historyGoals[dateStr] || defaultGoal || 3600000;
                html += `<div class="day-box ${getColorClass(ms, target)}" title="${dateStr}"></div>`;
            }
            return html;
        }
        function getColorClass(ms, goal) {
            if (ms < 3600000) return ''; 
            const pct = (ms / goal) * 100;
            if (pct >= 100) return 'hm-dgreen';
            if (pct >= 80) return 'hm-lgreen';
            if (pct >= 40) return 'hm-yellow';
            return 'hm-red';
        }
        window.toggleGoalInput = (uid) => document.getElementById(`goal-input-${uid}`).classList.toggle('show');
        
        window.saveGoal = (uid) => {
            const hours = parseFloat(document.getElementById(`input-hours-${uid}`).value);
            if (!hours) return;
            const newGoalMs = hours * 3600000;
            const userRef = ref(db, `users/${uid}`);
            get(userRef).then((snapshot) => {
                const data = snapshot.val() || {};
                const oldDefault = data.dailyGoal || 3600000;
                const history = data.history || {};
                const goals = data.goals || {};
                const todayStr = getLocalDayStr();
                
                let updates = {};
                // Backfill
                Object.keys(history).forEach(dateKey => {
                    if (dateKey !== todayStr && !goals[dateKey]) {
                        updates[`goals/${dateKey}`] = oldDefault;
                    }
                });
                
                // NEW: Save Goal + Set Lock Flag
                updates[`goals/${todayStr}`] = newGoalMs; 
                updates[`dailyGoal`] = newGoalMs;         
                updates[`goalLocks/${todayStr}`] = true; // Lock it now!
                
                update(userRef, updates).catch(err => alert("Goal Error: " + err.message));
                toggleGoalInput(uid);
            });
        };
        
        function getLocalDayStr(ts = Date.now()) {
            const d = new Date(ts);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function formatTime(ms) { 
            if(isNaN(ms)) return "00:00:00"; // Protection against NaN
            const s = Math.floor((ms/1000)%60); 
            const m = Math.floor((ms/(1000*60))%60); 
            const h = Math.floor((ms/(1000*60*60))); 
            return `${pad(h)}:${pad(m)}:${pad(s)}`; 
        }
        function formatHours(ms) { return (ms / (1000*60*60)).toFixed(1) + 'h'; }
        function pad(n) { return n < 10 ? '0'+n : n; }
    </script>
</body>
</html>
